function l = optical_stock_lenses(varargin)
% optical_stock_lenses: find and use stock lenses
%
% Syntax:
%   l = optical_stock_lenses(productstr)
% Use this to get the component layout for a lens you know by its
% product string
%
%   str = optical_stock_lenses('search',efl_func,n_components_func,cylindricalFlag)
% Search for lenses based on their effective focal length, # of components
% (e.g., 2 for a doublet), and whether it is cylindrical or not. Returns a
% cell array containing productstrings and focal-length information. Supply
% efl_func & n_surf_func as a function that returns true/false for each
% element of a vector input, e.g.,
%    efl_func = @(f) f > 6 & f < 12
% would return all lenses with focal lengths between +6 and +12.
% For parameters that are irrelevant to you, just leave that input empty.

persistent lens_table;

if isempty(lens_table)
  % lens table format: each row contains productstr, efl, n_components, iscylindrical, lensdata
  % eo = Edmund Optics
  % tl = Thorlabs
  % coc = Cylindrical Optics Company
  % to = Tower Optical (custom lenses)
  lens_table = {...
    'eo_49646',12,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/7.56,9),...
      struct('t',4.5,'material','lak8'),...
      opticalQuadratic(-1/12.80,9),...
      struct('t',1.50,'material','sf57'),...
      opticalQuadratic(1/61.6,9)); % aspherized achromat
    'eo_63692',12,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/7.35,4),...
      struct('t',1.8,'material','bk7'),...
      opticalQuadratic(-1/5.09,4),...
      struct('t',1,'material','sf5'),...
      opticalQuadratic(-1/14.6,4)); % achromat
    'eo_32299',12.5,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/8.63,6.25),...
      struct('t',3,'material','n-baf10'),...
      opticalQuadratic(-1/5.29,6.25),...
      struct('t',1,'material','sf10'),...
      opticalQuadratic(-1/51.17,6.25));  % achromat
    'eo_49924',7.5,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/5.6,6.25),...
      struct('t',5,'material','n-baf10'),...
      opticalQuadratic(-1/3.71,6.25),...
      struct('t',1,'material','sf10'),...
      opticalQuadratic(-1/11.34,6.25));  % achromat
    'eo_45208',10,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/6.98,6.25),...
      struct('t',3.06,'material','n-baf10'),...
      opticalQuadratic(-1/4.35,6.25),...
      struct('t',1.03,'material','sf10'),...
      opticalQuadratic(-1/41.01,6.25));  % achromat
    'eo_32301',15,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/7.95,6.25),...
      struct('t',2.70,'material','n-ssk8'),...
      opticalQuadratic(-1/7.25,6.25),...
      struct('t',0.6,'material','sf10'),...
      opticalQuadratic(-1/277.83,6.25));  % achromat
    'eo_49925',17.5,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/11.13,6.25),...
      struct('t',2.75,'material','n-ssk8'),...
      opticalQuadratic(-1/9.22,6.25),...
      struct('t',1,'material','sf56'),...
      opticalQuadratic(-1/38.49,6.25));  % achromat
     'eo_65435',12,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/6.70,9.00),...
      struct('t',6,'material','n-lak14'),...
      opticalQuadratic(-1/6.04,9.00),...
      struct('t',2,'material','sf66'),...
      opticalQuadratic(-1/198.81,9.00));  % achromat 
    'eo_47019',3.95,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/3.16,3),...
      struct('t',2,'material','n-baf10'),...
      opticalQuadratic(-1/2.23,3),...
      struct('t',1,'material','n-sf10'),...
      opticalQuadratic(-1/7.88,3)); % achromat
    'eo_47721',4.5,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/3.16,3),...
      struct('t',2,'material','n-lak22'),...
      opticalQuadratic(-1/2.23,3),...
      struct('t',1,'material','n-sf6'),...
      opticalQuadratic(-1/7.88,3));
    'eo_48371',-6.25,1,true,optical_layout_onaxis(...
      opticalQuadratic([-1/3.24 0],6.25),...
      struct('t',1,'material','bk7'),...
      opticalQuadratic([0 0],6.25));   % cylindrical
    'eo_68163',100.0,2,true,optical_layout_onaxis(...
      opticalQuadratic([0 1/51.21],[12.5 12.5]),...
      struct('t',3.0,'material','N-BK7'),...
      opticalQuadratic([0 -1/51.21],[12.5 12.5]),...
      struct('t',2.0,'material','N-SF5'),...
      opticalQuadratic([0 -1/222.95],[12.5 12.5])); % achromatic cylindrical       
    'tl_ac254-100-c',100,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/32.14,25.4),...
      struct('t',6.5,'material','n-baf10'),...
      opticalQuadratic(-1/38.02,25.4),...
      struct('t',1.8,'material','n-sf6ht'),...
      opticalQuadratic(1/93.54,25.4));  % achromat 
    'tl_ac254-150-c',150,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/42.69,25.4),...
      struct('t',5,'material','n-baf10'),...
      opticalQuadratic(-1/52.0,25.4),...
      struct('t',2.5,'material','n-sf6ht'),...
      opticalQuadratic(1/111.51,25.4));  % achromat 
    'tl_ac080-010-c',10.0,2,false,optical_layout_onaxis(...
      opticalQuadratic(1/7.08,8),...
      struct('t',4.2,'material','n-baf10'),...
      opticalQuadratic(-1/4.89,8),...
      struct('t',1,'material','n-sf6ht'),...
      opticalQuadratic(-1/20.89,8)); % achromat           
    'tl_LK1395L1',-3.9,1,true,optical_layout_onaxis(...
      opticalQuadratic([-1/2 0],[4 6]),...
      struct('t',2,'material','bk7'),...
      opticalQuadratic([0 0],[4 6]));   % cylindrical
    'tl_LK1597L1',-4,1,true,optical_layout_onaxis(...
      opticalQuadratic([-1/2.1 0],[4 6]),...
      struct('t',2,'material','bk7'),...
      opticalQuadratic([0 0],[4 6]));   % cylindrical
    'tl_LK1523L1',-5.8,1,true,optical_layout_onaxis(...
      opticalQuadratic([-1/3 0],[4 6]),...
      struct('t',2,'material','bk7'),...
      opticalQuadratic([0 0],[4 6]));   % cylindrical
    'coc_ACL001',7.5,2,true,optical_layout_onaxis(...
      opticalQuadratic([1/5.25 0],[5 5]),...
      struct('t',2.8,'material','n-baf10'),...
      opticalQuadratic([-1/3.9 0],[5 5]),...
      struct('t',1.7,'material','n-sf6ht'),...
      opticalQuadratic([-1/17.06 0],[5 5])); % achromatic cylindrical
    'coc_ACL002',10.0,2,true,optical_layout_onaxis(...
      opticalQuadratic([0 1/6.26],[8 8]),...
      struct('t',5.0,'material','H-K9L'),...
      opticalQuadratic([0 -1/4.7],[8 8]),...
      struct('t',3.0,'material','H-ZF52'),...
      opticalQuadratic([0 -1/10.12],[8 8])); % achromatic cylindrical 
    'coc_ACL002_reverse',10.0,2,true,optical_layout_onaxis(...
      opticalQuadratic([0 1/10.12],[8 8]),...
      struct('t',3.0,'material','H-ZF52'),...
      opticalQuadratic([0 1/4.7],[8 8]),...
      struct('t',5.0,'material','H-K9L'),...
      opticalQuadratic([0 -1/6.26],[8 8])); % achromatic cylindrical  
    'coc_ACL003',95.0,2,true,optical_layout_onaxis(...
      opticalQuadratic([0 1/94.3],[12 12]),...
      struct('t',8.0,'material','H-ZF6'),...
      opticalQuadratic([0 1/21.8],[12 12]),...
      struct('t',6.0,'material','H-LAK2'),...
      opticalQuadratic([0 -1/127.4],[12 12])); % achromatic cylindrical  
    'coc_ACL003_reverse',95.0,2,true,optical_layout_onaxis(...
      opticalQuadratic([0 1/127.4],[12 12]),...
      struct('t',6.0,'material','H-LAK2'),...
      opticalQuadratic([0 -1/21.8],[12 12]),...
      struct('t',8.0,'material','H-ZF6'),...
      opticalQuadratic([0 -1/94.3],[12 12])); % achromatic cylindrical 
    'coc_ACL004',136.0,2,true,optical_layout_onaxis(...
      opticalQuadratic([0 1/141.9],[12 12]),...
      struct('t',12.0,'material','H-ZF6'),...
      opticalQuadratic([0 1/31.4],[12 12]),...
      struct('t',10.0,'material','H-LAK2'),...
      opticalQuadratic([0 -1/169.8],[12 12])); % achromatic cylindrical 
    'coc_ACL004_reverse',136.0,2,true,optical_layout_onaxis(...
      opticalQuadratic([0 1/169.8],[12 12]),...
      struct('t',10.0,'material','H-LAK2'),...
      opticalQuadratic([0 -1/31.4],[12 12]),...
      struct('t',12.0,'material','H-ZF6'),...
      opticalQuadratic([0 -1/141.9],[12 12])); % achromatic cylindrical 
    'coc_ACL005',10.0,2,true,optical_layout_onaxis(...
      opticalQuadratic([0 1/5.3],[10 10]),...
      struct('t',5.5,'material','H-K9L'),...
      opticalQuadratic([0 -1/9.3],[10 10]),...
      struct('t',3.7,'material','H-ZF6'),...
      opticalQuadratic([0 -1/10.1],[10 10])); % achromatic cylindrical 
    'to_15320',-6.25,1,true,optical_layout_onaxis(...
      opticalQuadratic([-1/3.24 0],3),...
      struct('t',1,'material','BK7'),...
      opticalQuadratic([0 0],3)); % cylindrical 3mm PCV (really glass is H-K9L, but can't find data for it. BK7 is a "sister" glass)
    'water_immersion_achromat',16.5,2,false,optical_layout_onaxis(...
      opticalQuadratic(0.1569,5),...
      struct('t',2.2575,'material','bk7'),...
      opticalQuadratic(-0.1566,5),...
      struct('t',1.3368,'material','sf5'),...
      opticalQuadratic(-0.0678,5)); % optimized from eo_63692 for water, fixed working distance
    'coverslip1.5',Inf,1,false,optical_layout_onaxis(...
      opticalQuadratic(0,10),...
      struct('t',0.17,'material','bk7'),...
      opticalQuadratic(0,10))...
    };
end

if (strcmpi(varargin{1},'search'))
  f = cat(1,lens_table{:,2});
  n_comp = cat(1,lens_table{:,3});
  iscyl = cat(1,lens_table{:,4});
  keepFlag = true(size(lens_table,1),1);
  if ~isempty(varargin{2})
    keepFlag = keepFlag & varargin{2}(f);
  end
  if ~isempty(varargin{3})
    keepFlag = keepFlag & varargin{3}(n_comp);
  end
  if ~isempty(varargin{4})
    keepFlag = keepFlag & (iscyl == varargin{4});
  end
  l = lens_table(keepFlag,1:3);
else
  index = strmatch(varargin{1},lens_table(:,1),'exact');
  if isempty(index)
    error(['No lens with product string ' varargin{1} ' found']);
  end
  l = lens_table{index,end};
end
